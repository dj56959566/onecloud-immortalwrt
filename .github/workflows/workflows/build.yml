name: Build OneCloud ImmortalWrt ZIP

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "选择内核版本（默认 6.6）"
        required: false
        default: "6.6"
        type: choice
        options:
          - 6.6
          - 6.10
          - 6.12
  schedule:
    - cron: "0 4 1,16 * *"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 清理系统 & 扩容磁盘
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/lib/google-cloud-sdk
          sudo apt clean
          sudo fallocate -l 20G /mnt/work.img
          sudo mkfs.ext4 /mnt/work.img
          sudo mount -o loop /mnt/work.img /mnt
          sudo mkdir -p /mnt/workspace
          sudo chown $USER:$USER /mnt/workspace

      - name: 安装依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib             gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget curl upx-ucl
          sudo apt clean

      - name: 克隆 ImmortalWrt 24.10.4
        run: |
          cd /mnt/workspace
          git clone https://github.com/immortalwrt/immortalwrt.git -b v24.10.4 onecloud
          cd onecloud
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 应用配置和自定义
        run: |
          cd /mnt/workspace/onecloud
          cp $GITHUB_WORKSPACE/config/seed.config .config
          bash $GITHUB_WORKSPACE/scripts/diy.sh "${{ github.event.inputs.kernel_version || '6.6' }}"

      - name: 编译固件
        run: |
          cd /mnt/workspace/onecloud
          make defconfig
          make download -j8
          make -j$(nproc) V=s || make -j1 V=s

      - name: 打包 ZIP
        run: |
          cd /mnt/workspace/onecloud/bin/targets/*
          mkdir -p release
          find . -type f \( -name "*sysupgrade*.bin" -o -name "*.img" \) -exec mv {} release/ \;
          cd release
          zip -r OneCloud-Full-${{ github.event.inputs.kernel_version || '6.6' }}.zip .
          ls -lh

      - name: 清理虚拟磁盘
        if: always()
        run: |
          sudo umount /mnt || true
          sudo rm -f /mnt/work.img
          df -h
