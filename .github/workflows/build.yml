name: OneCloud ImmortalWrt\

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "选择内核版本（默认 6.6）"
        required: false
        default: "6.6"
        type: choice
        options:
          - 6.6
          - 6.10
          - 6.12
  schedule:
    - cron: "0 4 1,16 * *"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 释放磁盘空间
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: 安装依赖
        run: |
          sudo apt-get update && sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget curl upx-ucl \
          && sudo apt-get autoremove -y && sudo apt-get clean

      - name: 克隆 ImmortalWrt 24.10.4
        working-directory: /mnt/workspace
        run: |
          git clone -b v24.10.4 https://github.com/immortalwrt/immortalwrt.git onecloud

      - name: 应用配置和自定义
        working-directory: /mnt/workspace/onecloud
        run: |
          cp $GITHUB_WORKSPACE/config/seed.config .config
          bash $GITHUB_WORKSPACE/scripts/diy.sh "${{ github.event.inputs.kernel_version || '6.6' }}"

      - name: 更新 Feeds
        working-directory: /mnt/workspace/onecloud
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 下载 package
        working-directory: /mnt/workspace/onecloud
        run: |
          make defconfig
          make download -j8

      - name: 编译固件
        working-directory: /mnt/workspace/onecloud
        run: |
          make -j$(nproc) V=s || make -j1 V=s

      - name: 打包固件
        working-directory: /mnt/workspace/onecloud/bin/targets/*
        run: |
          mkdir -p release
          find . -type f \( -name "*sysupgrade*.bin" -o -name "*.img" \) -exec mv {} release/ \;
          cd release
          zip -r OneCloud-Full-${{ github.event.inputs.kernel_version || '6.6' }}.zip .

      - name: 上传构建产物
        uses: actions/upload-artifact@v3
        with:
          name: OneCloud-Firmware
          path: /mnt/workspace/onecloud/bin/targets/*/release/*.zip
