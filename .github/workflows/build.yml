name: Build OneCloud ImmortalWrt (Kernel 6.6)

on:
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00 è‡ªåŠ¨æ„å»º
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'é€‰æ‹©å†…æ ¸ç‰ˆæœ¬'
        required: true
        default: '6.6'
        type: choice
        options:
          - 6.6
          - 6.7
          - 6.9

permissions:
  contents: write   # âœ… å¿…é¡»ï¼šå…è®¸åˆ›å»º GitHub Releases

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½®æ„å»ºç¯å¢ƒ
        run: |
          sudo apt update
          sudo apt install -y build-essential ccache curl git unzip wget python3 python3-distutils

      - name: ä¸‹è½½æºç 
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git -b openwrt-24.10 openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: åº”ç”¨è‡ªå®šä¹‰ diy.sh
        run: |
          chmod +x diy.sh
          cd openwrt
          ../diy.sh

      - name: ç”Ÿæˆé»˜è®¤é…ç½®
        run: |
          cd openwrt
          make defconfig

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s
          echo "âœ… æ„å»ºå®Œæˆï¼Œå›ºä»¶è¾“å‡ºç›®å½•ï¼š"
          find bin/targets/ -type f

      # ä¸Šä¼ å›ºä»¶åˆ° Actionsï¼ˆä¿ç•™åœ¨æ„å»ºè®°å½•ä¸­ï¼‰
      - name: ä¸Šä¼ å›ºä»¶åˆ° Actions Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onecloud-immortalwrt-${{ github.run_id }}
          path: openwrt/bin/targets/

      # åˆ é™¤æ—§çš„ Releaseï¼ˆä»…ä¿ç•™æœ€æ–°ä¸€ä»½ï¼‰
      - name: åˆ é™¤æ—§ç‰ˆ Releases
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 1
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # åŒæ—¶å‘å¸ƒåˆ° GitHub Releases é¡µé¢
      - name: å‘å¸ƒå›ºä»¶åˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "onecloud-${{ github.run_number }}"
          name: "OneCloud ImmortalWrt Build #${{ github.run_number }}"
          body: |
            ğŸ§Š **OneCloud æ¯æ—¥è‡ªåŠ¨æ„å»ºå›ºä»¶**

            âœ… å†…æ ¸ç‰ˆæœ¬: ${{ github.event.inputs.kernel_version || '6.6' }}
            ğŸ•’ æ„å»ºæ—¶é—´: ${{ github.run_started_at }}

            ğŸŒ é»˜è®¤ç½‘ç»œé…ç½®ï¼š
            - IPï¼š192.168.2.2  
            - ç½‘å…³ï¼š192.168.2.1  
            - ç”¨æˆ·åï¼šroot  
            - å¯†ç ï¼šç©ºï¼ˆç•™ç©ºç™»å½•ï¼‰

            ğŸ“¦ ä¸‹æ–¹å¯ç›´æ¥ä¸‹è½½å›ºä»¶æ–‡ä»¶ï¼š
          files: |
            openwrt/bin/targets/**/*.img.gz
            openwrt/bin/targets/**/*.bin
            openwrt/bin/targets/**/*.manifest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
