name: Build OneCloud ImmortalWrt (Kernel 6.0)

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: '选择内核版本'
        required: true
        default: '6.0'
        type: choice
        options:
          - 6.0
          - 6.6
          - 6.10
  schedule:
    - cron: '0 16 * * *'  # 每天北京时间 00:00 自动构建

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout your repository
      uses: actions/checkout@v4

    - name: Clone ImmortalWrt source
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git -b openwrt-23.05 openwrt
        cd openwrt
        echo "✅ ImmortalWrt 源码克隆完成"

    - name: Copy custom files (feeds.conf.default, diy.sh, .config)
      run: |
        cd openwrt
        cp -f ../feeds.conf.default ./feeds.conf.default
        cp -f ../diy.sh ./diy.sh
        cp -f ../.config ./.config || true
        chmod +x diy.sh
        echo "✅ 已复制自定义配置文件"

    - name: Initialize build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache gcc g++ flex bison gawk gettext unzip zlib1g-dev file python3 rsync qemu-utils
        echo "✅ 编译环境准备完成"

    - name: Update & Install feeds
      run: |
        cd openwrt
        ./scripts/feeds clean
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "✅ feeds 更新完成"

    - name: Run custom diy.sh
      run: |
        cd openwrt
        ./diy.sh
        echo "✅ diy.sh 已执行完毕"

    - name: Build firmware
      run: |
        cd openwrt
        make defconfig
        make download -j8
        make -j$(nproc) || make -j1 V=s
        echo "✅ 固件编译完成"

    - name: Upload firmware to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OneCloud-ImmortalWrt-${{ github.run_id }}
        path: openwrt/bin/targets/
