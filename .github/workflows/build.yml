name: Build OneCloud ImmortalWrt (Kernel 6.0)

on:
  schedule:
    - cron: '0 16 * * *'   # 每日北京时间 00:00 自动构建
  workflow_dispatch:        # 手动触发支持
    inputs:
      kernel_version:
        description: '选择内核版本'
        required: true
        默认: '6.0'
        输入: choice
        options:
          - 6.0
          - 6.6
          - 6.10

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: 初始化编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc g++ flex bison gawk gettext unzip zlib1g-dev file python3 rsync qemu-utils

    - name: 更新 feeds
      run: |
        ./scripts/feeds clean
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 执行自定义脚本
      run: |
        chmod +x diy.sh
        ./diy.sh

    - name: 载入配置文件
      run: cp .config build_dir/.config || true

    - name: 开始编译固件
      run: |
        make defconfig
        make download -j8
        make -j$(nproc) || make -j1 V=s

    - name: 上传固件到 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OneCloud-ImmortalWrt-${{ github.run_id }}
        path: bin/targets/
