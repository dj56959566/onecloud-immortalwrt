name: Build OneCloud ImmortalWrt

on:
  schedule:
    - cron: '0 16 * * *'   # æ¯æ—¥åŒ—äº¬æ—¶é—´ 00:00 è‡ªåŠ¨ç¼–è¯‘
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'å¯é€‰ï¼šè¦†ç›–é»˜è®¤å†…æ ¸ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ 6.6ï¼‰'
        required: false
        default: '6.6'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
      - name: ğŸ§¹ æ¸…ç† runner ç£ç›˜ç©ºé—´
        run: |
          echo "Cleaning up runner space..."
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost || true
          sudo apt-get clean || true
          docker system prune -af || true
          df -h

      - name: ğŸ“¦ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: âš ï¸ è®¾ç½®å†…æ ¸ç‰ˆæœ¬ï¼ˆé»˜è®¤ 6.6ï¼Œå¯é€šè¿‡ workflow_dispatch è¦†ç›–ï¼‰
        run: |
          if [ -n "${{ github.event.inputs.kernel_version }}" ]; then
            echo "Using kernel override: ${{ github.event.inputs.kernel_version }}"
            echo "KERNEL_VERSION=${{ github.event.inputs.kernel_version }}" >> $GITHUB_ENV
          else
            echo "KERNEL_VERSION=6.6" >> $GITHUB_ENV
          fi
          echo "Kernel version set to $KERNEL_VERSION"

      - name: ğŸ§° å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y build-essential gcc g++ git wget curl unzip             python3 zstd rsync libncurses5-dev gawk gettext             libssl-dev xsltproc file bzip2 ccache

      - name: ğŸ—„ï¸ å‡†å¤‡ tmpfs ç¼–è¯‘ç›®å½•ï¼ˆé‡Šæ”¾ç£ç›˜å¹¶æå‡ IOï¼‰
        run: |
          sudo mkdir -p /mnt/workspace
          sudo mountpoint -q /mnt/workspace || sudo mount -t tmpfs -o size=8G tmpfs /mnt/workspace
          mkdir -p /mnt/workspace/build
          export TMPDIR=/mnt/workspace/build
          df -h /mnt/workspace || true
          echo "TMPDIR=/mnt/workspace/build" >> $GITHUB_ENV

      - name: ğŸ“¥ æ‹‰å– ImmortalWrt æºç 
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: âš™ï¸ å¯¼å…¥é…ç½®ä¸è‡ªå®šä¹‰è„šæœ¬
        run: |
          cd openwrt
          # å¤åˆ¶ seed config
          cp ../config/seed.config .config
          # ç¡®ä¿ diy.sh å¯æ‰§è¡Œå¹¶åœ¨ chroot å‰åšæ›¿æ¢/è°ƒæ•´
          chmod +x ../scripts/diy.sh
          ../scripts/diy.sh || true

      - name: ğŸš€ å¼€å§‹ç¼–è¯‘
        run: |
          cd openwrt
          # è‹¥éœ€è¦åœ¨ feeds æˆ– make ä¸­ä½¿ç”¨ KERNEL_VERSIONï¼Œå¯åœ¨æ­¤å†™å…¥ make variable æˆ– patch
          echo "Using KERNEL_VERSION=$KERNEL_VERSION"
          make defconfig
          # ç¼–è¯‘ï¼›è‹¥å¤±è´¥æ”¹ä¸ºå•çº¿ç¨‹è¾“å‡ºè¯¦ç»†æ—¥å¿—
          make -j$(nproc) || make -j1 V=s

      - name: ğŸ“¦ æ‰“åŒ…å›ºä»¶ä¸ç”Ÿæˆ Release ç›®å½•
        run: |
          mkdir -p release
          # æ‹·è´å¯èƒ½ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ï¼ˆå¦‚æœè·¯å¾„ä¸åŒè¯·æ ¹æ®å®é™…è°ƒæ•´ï¼‰
          cp -r openwrt/bin/targets/*/*/* release/ || true
          cd release
          echo "Build Time: $(date '+%Y-%m-%d %H:%M:%S')" > release_notes.txt
          echo "Kernel: $KERNEL_VERSION (default 6.6 LTS)" >> release_notes.txt
          sha256sum * > checksum.sha256 || true
          zip -r onecloud-immortal-$(date +%Y%m%d)-stable.zip ./* || true
          ls -lah

      - name: ğŸš€ å‘å¸ƒåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.zip
          tag_name: nightly
          name: "OneCloud ImmortalWrt è‡ªåŠ¨æ„å»º"
          body_path: release/release_notes.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§¹ æ¸…ç†æ—§ Releaseï¼ˆä¿ç•™æœ€æ–°1ä¸ªï¼‰
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
