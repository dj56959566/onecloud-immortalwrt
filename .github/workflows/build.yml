name: Build OneCloud ImmortalWrt (Kernel 6.6)

on:
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00 è‡ªåŠ¨æ„å»º
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'é€‰æ‹©å†…æ ¸ç‰ˆæœ¬'
        required: true
        default: '6.6'
        type: choice
        options:
          - 6.6
          - 6.7
          - 6.9

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½®æ„å»ºç¯å¢ƒ
        run: |
          sudo apt update
          sudo apt install -y build-essential ccache curl git unzip wget python3 python3-distutils

      - name: ä¸‹è½½ ImmortalWrt æºç 
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git -b openwrt-24.10 openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: åº”ç”¨è‡ªå®šä¹‰ diy.sh
        run: |
          chmod +x diy.sh
          cd openwrt
          ../diy.sh

      - name: ç”Ÿæˆé»˜è®¤é…ç½®
        run: |
          cd openwrt
          make defconfig

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: æ‰“åŒ…å›ºä»¶å‹ç¼©åŒ…
        run: |
          cd openwrt/bin/targets
          # æ‰¾åˆ°ç›®æ ‡æ¶æ„ç›®å½•ï¼ˆå¦‚ï¼šarmvirt/32ï¼‰
          TARGET_DIR=$(find . -mindepth 2 -maxdepth 2 -type d | head -n 1)
          cd "$TARGET_DIR"
          mkdir -p ../../../release
          tar -czf ../../../release/onecloud-immortalwrt-${{ github.run_number }}.tar.gz ./*
          echo "âœ… æ‰“åŒ…å®Œæˆï¼šonecloud-immortalwrt-${{ github.run_number }}.tar.gz"

      - name: ä¸Šä¼ å›ºä»¶åˆ° Actions Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onecloud-immortalwrt-${{ github.run_id }}
          path: openwrt/release/

      - name: å‘å¸ƒåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: "onecloud-${{ github.run_number }}"
          name: "OneCloud ImmortalWrt Build #${{ github.run_number }}"
          body: |
            ğŸ‰ è‡ªåŠ¨æ„å»ºæˆåŠŸï¼

            âœ… å†…æ ¸ç‰ˆæœ¬: ${{ github.event.inputs.kernel_version || '6.6' }}
            ğŸ•’ æ„å»ºæ—¶é—´: ${{ github.run_started_at }}
            ğŸ“¦ å›ºä»¶æ–‡ä»¶åˆ—è¡¨å¦‚ä¸‹ï¼š

            - OneCloud ImmortalWrt å›ºä»¶ (ARMv7)
            - é»˜è®¤ IP: 192.168.2.2
            - ç½‘å…³: 192.168.2.1
            - ç”¨æˆ·å: root
            - å¯†ç : ç©ºï¼ˆç•™ç©ºç™»å½•ï¼‰

            ğŸ’¡ æ„å»ºä»“åº“: [${{ github.repository }}](https://github.com/${{ github.repository }})
          files: |
            openwrt/release/*.tar.gz
