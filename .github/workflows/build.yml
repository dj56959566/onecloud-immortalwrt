name: Build OneCloud ImmortalWrt (Kernel 6.6)

on:
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00 è‡ªåŠ¨æ„å»ºï¼ˆUTC+8ï¼‰
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'é€‰æ‹©å†…æ ¸ç‰ˆæœ¬'
        required: true
        default: '6.6'
        type: choice
        options:
          - 6.6
          - 6.7
          - 6.9

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½®æ„å»ºç¯å¢ƒ
        run: |
          sudo apt update
          sudo apt install -y build-essential ccache curl git unzip wget python3 gzip xz-utils

      - name: ä¸‹è½½æºç 
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git -b openwrt-24.10 openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: åº”ç”¨è‡ªå®šä¹‰ diy.sh
        run: |
          chmod +x diy.sh
          cd openwrt
          ../diy.sh

      # âœ… æ·»åŠ å¼ºåˆ¶å¯ç”¨ ext4 é•œåƒé…ç½®
      - name: å¯ç”¨ ext4 é•œåƒæ”¯æŒ
        run: |
          cd openwrt
          cat >> .config <<EOF
          CONFIG_TARGET_ROOTFS_EXT4=y
          CONFIG_TARGET_ROOTFS_SQUASHFS=y
          CONFIG_TARGET_EXT4_BLOCKSIZE_4096=y
          CONFIG_TARGET_IMAGES_GZIP=y
          EOF
          make defconfig

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      # âœ… æ‰“åŒ…çº¿åˆ·é•œåƒ
      - name: æ‰“åŒ…çº¿åˆ·é•œåƒ
        run: |
          cd openwrt/bin/targets/*/*
          mkdir -p release

          # æ‰¾åˆ° ext4 é•œåƒ
          IMG=$(ls *-ext4-sysupgrade.img.gz | head -n 1 || true)
          if [ -z "$IMG" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ° ext4 é•œåƒï¼Œå°è¯•ä» squashfs é•œåƒè½¬æ¢"
            IMG=$(ls *-squashfs-sysupgrade.bin | head -n 1 || true)
          fi

          if [ -z "$IMG" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å¯ç”¨é•œåƒï¼Œæ— æ³•ç”Ÿæˆçº¿åˆ·åŒ…"
            exit 1
          fi

          # è§£å‹/æ‹·è´ rootfs
          if [[ "$IMG" == *.gz ]]; then
            gunzip -c "$IMG" > rootfs.img
          else
            cp "$IMG" rootfs.img
          fi

          echo "ğŸ§© ç”Ÿæˆ eMMC çº¿åˆ·é•œåƒ..."
          dd if=/dev/zero of=onecloud_emmc_flash.img bs=1M count=2048
          parted onecloud_emmc_flash.img --script mklabel gpt
          parted onecloud_emmc_flash.img --script mkpart boot ext4 1MiB 64MiB
          parted onecloud_emmc_flash.img --script mkpart root ext4 64MiB 100%
          dd if=rootfs.img of=onecloud_emmc_flash.img bs=1M seek=64 conv=fsync

          gzip -c onecloud_emmc_flash.img > release/onecloud_emmc_flash_${{ github.event.inputs.kernel_version || '6.6' }}.img.gz
          echo "âœ… çº¿åˆ·åŒ…ç”Ÿæˆå®Œæˆ"

      - name: å‘å¸ƒåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: "build-${{ github.run_id }}"
          name: "OneCloud ImmortalWrt çº¿åˆ·åŒ… (Kernel ${{ github.event.inputs.kernel_version || '6.6' }})"
          body: |
            è‡ªåŠ¨æ„å»ºçš„ OneCloud ImmortalWrt çº¿åˆ·åŒ…  
            - å†…æ ¸ç‰ˆæœ¬ï¼š${{ github.event.inputs.kernel_version || '6.6' }}  
            - ç¼–è¯‘æ—¶é—´ï¼š${{ github.run_started_at }}  
            - è®¾å¤‡ï¼šOneCloud  
            - åˆ†æ”¯ï¼šopenwrt-24.10  
            - é•œåƒæ ¼å¼ï¼š`.img.gz`ï¼ˆå¯ç›´æ¥ dd æˆ– USB Burning Tool åˆ·å…¥ eMMCï¼‰
          files: |
            openwrt/bin/targets/*/*/release/*.img.gz

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
